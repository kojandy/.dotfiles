name: Build
on:
  workflow_dispatch:
  push:
    branches: master
    paths:
      - '**.nix'
      - 'flake.lock'
  pull_request:
    paths:
      - '**.nix'
      - 'flake.lock'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: studio
            runs_on: macos-latest
            target: darwinConfigurations.studio.system
          - name: nix-on-droid
            runs_on: ubuntu-24.04-arm
            target: nixOnDroidConfigurations.default.activationPackage
            build_flags: "--impure"
            extra_pull_names: "nix-on-droid"
            skip-diff: true
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - uses: nixbuild/nix-quick-install-action@2c9db80fb984ceb1bcaa77cdda3fdf8cfba92035 # v34
      - uses: cachix/cachix-action@3ba601ff5bbb07c7220846facfa2cd81eeee15a1 # v16
        with:
          name: kojandy
          extraPullNames: ${{ matrix.extra_pull_names }}
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Build ${{ matrix.target }}
        id: build_head
        run: |
          set -euo pipefail
          path="$(nix build .#${{ matrix.target }} ${{ matrix.build_flags }} --print-out-paths)"
          echo "path=$path" >> "$GITHUB_OUTPUT"
      - name: Compute Nix package diff
        if: ${{ !matrix.skip-diff && github.event_name == 'pull_request' }}
        shell: bash
        run: |
          set -euo pipefail
          tmpdir="$(mktemp -d)"
          git worktree add "$tmpdir" "${{ github.event.pull_request.base.sha }}"

          old_path="$(nix build "$tmpdir"#${{ matrix.target }} ${{ matrix.build_flags }} --print-out-paths)"
          new_path="${{ steps.build_head.outputs.path }}"

          nix run github:faukah/dix?ref=v1.4.2 -- "$old_path" "$new_path" > dix.raw

          line_count="$(wc -l < dix.raw | awk '{$1=$1};1')"
          [ "$line_count" -eq 5 ] && exit 0
          {
            echo "<!-- dix-diff:${{ matrix.name }} -->"
            echo "### Nix package diff"
            echo "Target: \`${{ matrix.target }}\`"
            echo '```'
            (grep '^\[[A-Z][^.]\]' dix.raw || echo "No changes in system-wide packages.") | sort -k2
            echo
            tail -n2 dix.raw
            echo '```'
            echo "<details>"
            echo "<summary>Show full diff (${line_count} lines)</summary>"
            echo
            echo '```'
            cat dix.raw
            echo '```'
            echo "</details>"
          } > dix-comment.md
      - name: Find existing diff comment
        if: ${{ hashFiles('dix-comment.md') != '' }}
        uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad # v4.0.0
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: "<!-- dix-diff:${{ matrix.name }} -->"
      - name: Update diff comment on PR
        if: ${{ hashFiles('dix-comment.md') != '' }}
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-file: dix-comment.md
          edit-mode: replace
