name: Build
on:
  workflow_dispatch:
  push:
    branches: master
    paths:
      - '**.nix'
      - 'flake.lock'
  pull_request:
    paths:
      - '**.nix'
      - 'flake.lock'

jobs:
  build:
    strategy:
      matrix:
        include:
          - system: darwin
            runs-on: macos-latest
            target: .#darwinConfigurations.studio.system
            build-args: ''
          - system: nix-on-droid
            runs-on: ubuntu-latest
            target: .#nixOnDroidConfigurations.default.activationPackage
            build-args: '--impure --extra-platforms aarch64-linux'
            qemu: true
            cachix-extra-pull: nix-on-droid
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v5
      - uses: docker/setup-qemu-action@v3
        if: matrix.qemu
        with:
          platforms: arm64
      - uses: nixbuild/nix-quick-install-action@v33
      - uses: cachix/cachix-action@v16
        with:
          name: kojandy
          extraPullNames: ${{ matrix.cachix-extra-pull || '' }}
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - run: nix build ${{ matrix.target }} ${{ matrix.build-args }}
